<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | Personal Finance App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        h2 {
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .summary-card {
            flex: 1;
            min-width: 220px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        }

        .summary-card h3 {
            margin: 0;
            font-size: 14px;
            color: #6b7280;
        }

        .summary-card p {
            margin: 8px 0 0;
            font-size: 22px;
            font-weight: 600;
        }

        .income { color: #16a34a; }
        .expense { color: #dc2626; }
        .savings { color: #2563eb; }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            margin-top: 30px;
        }

        .chart-container {
            height: 350px;
        }

        .btn {
            margin-top: 20px;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #2563eb;
            color: white;
        }

        .logout-btn {
            background: #dc2626;
        }
    </style>
</head>

<body onload="requireAuth(); loadDashboard();">

<h2>Dashboard Overview</h2>

<div class="summary-row">
    <div class="summary-card">
        <h3>Total Income</h3>
        <p id="totalIncome" class="income">₹0</p>
    </div>

    <div class="summary-card">
        <h3>Total Expense</h3>
        <p id="totalExpense" class="expense">₹0</p>
    </div>

    <div class="summary-card">
        <h3>Net Savings</h3>
        <p id="netSavings" class="savings">₹0</p>
    </div>

    <div class="summary-card">
        <h3>Savings %</h3>
        <p id="savingsPercent">0%</p>
    </div>
</div>

<div class="card">
    <h3>Income vs Expense</h3>
    <div class="chart-container">
        <canvas id="summaryChart"></canvas>
    </div>
</div>

<button class="btn" onclick="goToIncome()">Income</button>
<button class="btn" onclick="goToExpense()">Expense</button>
<button class="btn logout-btn" onclick="logout()">Logout</button>

<script src="../js/guard.js"></script>
<script src="../js/api.js"></script>
<script src="../js/auth.js"></script>

<script>

    let chartInstance;

    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR'
        }).format(amount);
    }

    function loadDashboard() {

        Promise.all([
            apiRequest("/incomes").then(res => res.json()),
            apiRequest("/expenses").then(res => res.json())
        ]).then(([incomes, expenses]) => {

            let totalIncome = 0;
            let totalExpense = 0;

            incomes.forEach(i => totalIncome += parseFloat(i.amount));
            expenses.forEach(e => totalExpense += parseFloat(e.amount));

            const netSavings = totalIncome - totalExpense;
            const savingsPercent = totalIncome > 0
                ? ((netSavings / totalIncome) * 100).toFixed(1)
                : 0;

            document.getElementById("totalIncome").innerText = formatCurrency(totalIncome);
            document.getElementById("totalExpense").innerText = formatCurrency(totalExpense);
            document.getElementById("netSavings").innerText = formatCurrency(netSavings);
            document.getElementById("savingsPercent").innerText = savingsPercent + "%";

            renderChart(totalIncome, totalExpense);
        });
    }

    function renderChart(income, expense) {

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(document.getElementById("summaryChart"), {
            type: 'bar',
            data: {
                labels: ['Income', 'Expense'],
                datasets: [{
                    label: 'Amount',
                    data: [income, expense]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    function goToIncome() {
        window.location.href = "/pages/income.html";
    }

    function goToExpense() {
        window.location.href = "/pages/expense.html";
    }

</script>

</body>
</html>